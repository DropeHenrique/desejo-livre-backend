FROM php:8.3-fpm

# Tudo acontece em /code (EasyPanel clona aí)
WORKDIR /code

# Sistema
RUN apt-get update && apt-get install -y \
    git curl ca-certificates gnupg \
    libpng-dev libonig-dev libxml2-dev libpq-dev libzip-dev \
    zip unzip supervisor cron \
 && rm -rf /var/lib/apt/lists/*

# Node 20.x (Vite 7 exige)
RUN mkdir -p /etc/apt/keyrings \
 && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
 && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" > /etc/apt/sources.list.d/nodesource.list \
 && apt-get update && apt-get install -y nodejs \
 && node -v && npm -v

# PHP extensions + Redis
RUN docker-php-ext-install pdo_pgsql mbstring exif pcntl bcmath gd zip
RUN pecl install redis && docker-php-ext-enable redis

# Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# PHP-FPM ouvindo TCP (não socket)
RUN sed -i 's|^listen = .*|listen = 0.0.0.0:9000|' /usr/local/etc/php-fpm.d/www.conf

# Entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 9000
CMD ["entrypoint.sh"]
