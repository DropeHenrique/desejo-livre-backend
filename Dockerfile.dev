# Dockerfile.dev
FROM php:8.3-fpm

# 1) Dependências do sistema
RUN apt-get update && apt-get install -y \
    git curl zip unzip \
    libpng-dev libonig-dev libxml2-dev libpq-dev libzip-dev \
    nginx supervisor cron \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

# 2) Extensões do PHP
RUN docker-php-ext-install pdo_pgsql mbstring exif pcntl bcmath gd zip
RUN pecl install redis && docker-php-ext-enable redis

# 3) Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# 4) Diretório de trabalho
WORKDIR /var/www

# 5) Copiar projeto
COPY . /var/www

# 6) Permissões para Laravel
RUN chown -R www-data:www-data /var/www \
 && find storage bootstrap/cache -type d -exec chmod 775 {} \; \
 && find storage bootstrap/cache -type f -exec chmod 664 {} \;

# 7) Configs Nginx e Supervisor
# Remover confs default que colidem com nossa server block
RUN rm -f /etc/nginx/conf.d/* /etc/nginx/sites-enabled/default /etc/nginx/sites-available/default || true
COPY docker/nginx/default.conf /etc/nginx/conf.d/default.conf
COPY docker/supervisor/supervisord.conf /etc/supervisor/supervisord.conf
COPY docker/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# 8) Expoe HTTP (nginx)
EXPOSE 80

# 9) Entrypoint (faz composer install, migrate, etc) e inicia supervisor
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]
